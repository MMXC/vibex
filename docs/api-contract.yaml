openapi: 3.0.3
info:
  title: VibeX API Contract
  description: |
    VibeX 全栈项目 API 契约文档
    
    ## 前后端差距分析
    
    ### 前端期望但后端未实现的 API
    | 接口 | 前端调用 | 后端状态 | 优先级 |
    |------|----------|----------|--------|
    | POST /api/auth/login | 登录 | ❌ 缺失 | P0 |
    | POST /api/auth/register | 注册 | ❌ 缺失 | P0 |
    | POST /api/auth/logout | 登出 | ❌ 缺失 | P1 |
    | GET /api/users/:id | 获取用户 | ❌ 缺失 | P1 |
    | PUT /api/users/:id | 更新用户 | ❌ 缺失 | P1 |
    | GET /api/messages | 获取消息列表 | ❌ 缺失 | P0 |
    | POST /api/messages | 创建消息 | ❌ 缺失 | P0 |
    | DELETE /api/messages/:id | 删除消息 | ❌ 缺失 | P2 |
    | GET /api/flows/:id | 获取流程图 | ❌ 缺失 | P1 |
    | PUT /api/flows/:id | 更新流程图 | ❌ 缺失 | P1 |
    | DELETE /api/flows/:id | 删除流程图 | ❌ 缺失 | P2 |
    
    ### 后端已实现但前端未调用的 API
    | 接口 | 后端实现 | 前端状态 |
    |------|----------|----------|
    | GET /api/agents | Agent 列表 | 未集成 |
    | POST /api/agents | 创建 Agent | 未集成 |
    | GET /api/pages | 页面列表 | 未集成 |
    | POST /api/pages | 创建页面 | 未集成 |
    
    ### 完全匹配的 API
    | 接口 | 前端 | 后端 | 备注 |
    |------|------|------|------|
    | GET /api/projects | ✅ | ✅ | 参数略有差异 |
    | POST /api/projects | ❌ | ✅ | 前端用 PUT，应用 POST |
    | GET /api/projects/:id | ✅ | ✅ | 匹配 |
    | PUT /api/projects/:id | ✅ | ✅ | 匹配 |
    | DELETE /api/projects/:id | ✅ | ✅ | 匹配 |
    | POST /api/chat | ✅ | ✅ | 流式响应 |
    
  version: 1.0.0
  contact:
    name: VibeX Team
    
servers:
  - url: /api
    description: API 基础路径

tags:
  - name: Auth
    description: 认证相关接口
  - name: Users
    description: 用户管理
  - name: Projects
    description: 项目管理
  - name: Messages
    description: 对话消息
  - name: Flows
    description: 流程图数据
  - name: Agents
    description: Agent 管理
  - name: Pages
    description: 页面管理

paths:
  # ==================== 认证 ====================
  /auth/login:
    post:
      tags: [Auth]
      summary: 用户登录
      description: 前端需要，后端缺失
      operationId: login
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LoginRequest'
      responses:
        '200':
          description: 登录成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '400':
          $ref: '#/components/responses/BadRequest'

  /auth/register:
    post:
      tags: [Auth]
      summary: 用户注册
      description: 前端需要，后端缺失
      operationId: register
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RegisterRequest'
      responses:
        '201':
          description: 注册成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '409':
          description: 邮箱已存在

  /auth/logout:
    post:
      tags: [Auth]
      summary: 用户登出
      description: 前端需要，后端缺失
      operationId: logout
      security:
        - bearerAuth: []
      responses:
        '200':
          description: 登出成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessResponse'

  # ==================== 用户 ====================
  /users/{userId}:
    get:
      tags: [Users]
      summary: 获取用户信息
      description: 前端需要，后端缺失
      operationId: getUser
      parameters:
        - $ref: '#/components/parameters/UserId'
      responses:
        '200':
          description: 成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'
        '404':
          $ref: '#/components/responses/NotFound'
    
    put:
      tags: [Users]
      summary: 更新用户信息
      description: 前端需要，后端缺失
      operationId: updateUser
      parameters:
        - $ref: '#/components/parameters/UserId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UserUpdate'
      responses:
        '200':
          description: 更新成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'
        '404':
          $ref: '#/components/responses/NotFound'

  # ==================== 项目 ====================
  /projects:
    get:
      tags: [Projects]
      summary: 获取项目列表
      operationId: getProjects
      parameters:
        - name: userId
          in: query
          description: 按用户筛选
          schema:
            type: string
      responses:
        '200':
          description: 成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  projects:
                    type: array
                    items:
                      $ref: '#/components/schemas/Project'
        '500':
          $ref: '#/components/responses/InternalError'
    
    post:
      tags: [Projects]
      summary: 创建项目
      operationId: createProject
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ProjectCreate'
      responses:
        '201':
          description: 创建成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  project:
                    $ref: '#/components/schemas/Project'
        '400':
          $ref: '#/components/responses/BadRequest'
        '500':
          $ref: '#/components/responses/InternalError'

  /projects/{projectId}:
    get:
      tags: [Projects]
      summary: 获取单个项目
      operationId: getProject
      parameters:
        - $ref: '#/components/parameters/ProjectId'
      responses:
        '200':
          description: 成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  project:
                    $ref: '#/components/schemas/Project'
        '404':
          $ref: '#/components/responses/NotFound'
    
    put:
      tags: [Projects]
      summary: 更新项目
      operationId: updateProject
      parameters:
        - $ref: '#/components/parameters/ProjectId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ProjectUpdate'
      responses:
        '200':
          description: 更新成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  project:
                    $ref: '#/components/schemas/Project'
        '404':
          $ref: '#/components/responses/NotFound'
    
    delete:
      tags: [Projects]
      summary: 删除项目
      operationId: deleteProject
      parameters:
        - $ref: '#/components/parameters/ProjectId'
      responses:
        '200':
          description: 删除成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessResponse'
        '404':
          $ref: '#/components/responses/NotFound'

  # ==================== 消息 ====================
  /messages:
    get:
      tags: [Messages]
      summary: 获取消息列表
      description: 前端需要，后端缺失
      operationId: getMessages
      parameters:
        - name: projectId
          in: query
          required: true
          schema:
            type: string
      responses:
        '200':
          description: 成功
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Message'
        '400':
          $ref: '#/components/responses/BadRequest'
    
    post:
      tags: [Messages]
      summary: 创建消息
      description: 前端需要，后端缺失
      operationId: createMessage
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/MessageCreate'
      responses:
        '201':
          description: 创建成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Message'
        '400':
          $ref: '#/components/responses/BadRequest'

  /messages/{messageId}:
    delete:
      tags: [Messages]
      summary: 删除消息
      description: 前端需要，后端缺失
      operationId: deleteMessage
      parameters:
        - name: messageId
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: 删除成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessResponse'
        '404':
          $ref: '#/components/responses/NotFound'

  # ==================== 流程图 ====================
  /flows/{flowId}:
    get:
      tags: [Flows]
      summary: 获取流程图
      description: 前端需要，后端缺失
      operationId: getFlow
      parameters:
        - name: flowId
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: 成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/FlowData'
        '404':
          $ref: '#/components/responses/NotFound'
    
    put:
      tags: [Flows]
      summary: 更新流程图
      description: 前端需要，后端缺失
      operationId: updateFlow
      parameters:
        - name: flowId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/FlowDataUpdate'
      responses:
        '200':
          description: 更新成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/FlowData'
        '404':
          $ref: '#/components/responses/NotFound'
    
    delete:
      tags: [Flows]
      summary: 删除流程图
      description: 前端需要，后端缺失
      operationId: deleteFlow
      parameters:
        - name: flowId
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: 删除成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessResponse'
        '404':
          $ref: '#/components/responses/NotFound'

  # ==================== Chat ====================
  /chat:
    post:
      tags: [Chat]
      summary: AI 对话（流式）
      operationId: chat
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - message
              properties:
                message:
                  type: string
                  description: 用户消息
                conversationId:
                  type: string
                  description: 会话 ID（可选）
                history:
                  type: array
                  items:
                    type: object
                    properties:
                      role:
                        type: string
                        enum: [user, assistant]
                      content:
                        type: string
      responses:
        '200':
          description: 流式响应
          content:
            text/event-stream:
              schema:
                type: string
                description: SSE 格式的流式数据
        '400':
          $ref: '#/components/responses/BadRequest'
    
    get:
      tags: [Chat]
      summary: Chat API 状态
      operationId: chatStatus
      responses:
        '200':
          description: API 正常
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: ok
                  message:
                    type: string

  # ==================== Agents ====================
  /agents:
    get:
      tags: [Agents]
      summary: 获取 Agent 列表
      operationId: getAgents
      parameters:
        - name: userId
          in: query
          schema:
            type: string
      responses:
        '200':
          description: 成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  agents:
                    type: array
                    items:
                      $ref: '#/components/schemas/Agent'
    
    post:
      tags: [Agents]
      summary: 创建 Agent
      operationId: createAgent
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AgentCreate'
      responses:
        '201':
          description: 创建成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  agent:
                    $ref: '#/components/schemas/Agent'

  /agents/{agentId}:
    get:
      tags: [Agents]
      summary: 获取单个 Agent
      operationId: getAgent
      parameters:
        - name: agentId
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: 成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  agent:
                    $ref: '#/components/schemas/Agent'
        '404':
          $ref: '#/components/responses/NotFound'
    
    put:
      tags: [Agents]
      summary: 更新 Agent
      operationId: updateAgent
      parameters:
        - name: agentId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AgentUpdate'
      responses:
        '200':
          description: 更新成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  agent:
                    $ref: '#/components/schemas/Agent'
    
    delete:
      tags: [Agents]
      summary: 删除 Agent
      operationId: deleteAgent
      parameters:
        - name: agentId
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: 删除成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessResponse'

  # ==================== Pages ====================
  /pages:
    get:
      tags: [Pages]
      summary: 获取页面列表
      operationId: getPages
      parameters:
        - name: projectId
          in: query
          schema:
            type: string
      responses:
        '200':
          description: 成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  pages:
                    type: array
                    items:
                      $ref: '#/components/schemas/Page'
    
    post:
      tags: [Pages]
      summary: 创建页面
      operationId: createPage
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PageCreate'
      responses:
        '201':
          description: 创建成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  page:
                    $ref: '#/components/schemas/Page'

  /pages/{pageId}:
    get:
      tags: [Pages]
      summary: 获取单个页面
      operationId: getPage
      parameters:
        - name: pageId
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: 成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  page:
                    $ref: '#/components/schemas/Page'
        '404':
          $ref: '#/components/responses/NotFound'
    
    put:
      tags: [Pages]
      summary: 更新页面
      operationId: updatePage
      parameters:
        - name: pageId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PageUpdate'
      responses:
        '200':
          description: 更新成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  page:
                    $ref: '#/components/schemas/Page'
    
    delete:
      tags: [Pages]
      summary: 删除页面
      operationId: deletePage
      parameters:
        - name: pageId
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: 删除成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessResponse'

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  parameters:
    UserId:
      name: userId
      in: path
      required: true
      schema:
        type: string
      description: 用户 ID
    
    ProjectId:
      name: projectId
      in: path
      required: true
      schema:
        type: string
      description: 项目 ID

  schemas:
    # ===== 用户相关 =====
    User:
      type: object
      required:
        - id
        - name
        - email
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
        email:
          type: string
          format: email
        avatar:
          type: string
          nullable: true
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time
    
    UserUpdate:
      type: object
      properties:
        name:
          type: string
        avatar:
          type: string
          nullable: true

    # ===== 认证相关 =====
    LoginRequest:
      type: object
      required:
        - email
        - password
      properties:
        email:
          type: string
          format: email
        password:
          type: string
          format: password
    
    RegisterRequest:
      type: object
      required:
        - name
        - email
        - password
      properties:
        name:
          type: string
        email:
          type: string
          format: email
        password:
          type: string
          format: password
          minLength: 8
    
    AuthResponse:
      type: object
      properties:
        token:
          type: string
          description: JWT 认证令牌
        user:
          $ref: '#/components/schemas/User'

    # ===== 项目相关 =====
    Project:
      type: object
      required:
        - id
        - name
        - userId
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
        userId:
          type: string
          format: uuid
        description:
          type: string
          nullable: true
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time
        pages:
          type: array
          items:
            $ref: '#/components/schemas/Page'
    
    ProjectCreate:
      type: object
      required:
        - name
        - userId
      properties:
        name:
          type: string
          minLength: 1
        description:
          type: string
        userId:
          type: string
    
    ProjectUpdate:
      type: object
      properties:
        name:
          type: string
        description:
          type: string
          nullable: true

    # ===== 消息相关 =====
    Message:
      type: object
      required:
        - id
        - role
        - content
        - projectId
      properties:
        id:
          type: string
          format: uuid
        role:
          type: string
          enum: [user, assistant, system]
        content:
          type: string
        projectId:
          type: string
          format: uuid
        createdAt:
          type: string
          format: date-time
    
    MessageCreate:
      type: object
      required:
        - content
        - projectId
      properties:
        content:
          type: string
        projectId:
          type: string
        role:
          type: string
          enum: [user, assistant, system]
          default: user

    # ===== 流程图相关 =====
    FlowData:
      type: object
      required:
        - id
        - nodes
        - edges
        - projectId
      properties:
        id:
          type: string
          format: uuid
        nodes:
          type: array
          items:
            type: object
            description: React Flow 节点
        edges:
          type: array
          items:
            type: object
            description: React Flow 连线
        projectId:
          type: string
          format: uuid
        name:
          type: string
          nullable: true
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time
    
    FlowDataUpdate:
      type: object
      properties:
        nodes:
          type: array
          items:
            type: object
        edges:
          type: array
          items:
            type: object
        name:
          type: string
          nullable: true

    # ===== Agent 相关 =====
    Agent:
      type: object
      required:
        - id
        - name
        - prompt
        - userId
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
        prompt:
          type: string
          description: Agent 系统提示词
        model:
          type: string
          default: abab6.5s-chat
        temperature:
          type: number
          minimum: 0
          maximum: 1
          default: 0.7
        userId:
          type: string
          format: uuid
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time
    
    AgentCreate:
      type: object
      required:
        - name
        - prompt
        - userId
      properties:
        name:
          type: string
        prompt:
          type: string
        model:
          type: string
          default: abab6.5s-chat
        temperature:
          type: number
          default: 0.7
        userId:
          type: string
    
    AgentUpdate:
      type: object
      properties:
        name:
          type: string
        prompt:
          type: string
        model:
          type: string
        temperature:
          type: number

    # ===== 页面相关 =====
    Page:
      type: object
      required:
        - id
        - name
        - projectId
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
        content:
          type: string
          nullable: true
          description: 页面内容 (JSON 或 HTML)
        projectId:
          type: string
          format: uuid
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time
        project:
          $ref: '#/components/schemas/Project'
    
    PageCreate:
      type: object
      required:
        - name
        - projectId
      properties:
        name:
          type: string
        content:
          type: string
          nullable: true
        projectId:
          type: string
    
    PageUpdate:
      type: object
      properties:
        name:
          type: string
        content:
          type: string
          nullable: true

    # ===== 通用响应 =====
    SuccessResponse:
      type: object
      properties:
        success:
          type: boolean
          example: true
    
    ErrorResponse:
      type: object
      properties:
        error:
          type: string
          description: 错误消息

  responses:
    BadRequest:
      description: 请求参数错误
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
    
    Unauthorized:
      description: 未认证
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
    
    NotFound:
      description: 资源不存在
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
    
    InternalError:
      description: 服务器内部错误
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'